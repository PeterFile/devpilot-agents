# Multi-Agent Orchestration System - æ·±åº¦åˆ†ææ–‡æ¡£

## æ¦‚è¿°

Multi-Agent Orchestration æ˜¯ä¸€ä¸ªåè°ƒå¤šä¸ª AI ä»£ç†ï¼ˆcodexã€Geminiã€Codexï¼‰å¹¶è¡Œæ‰§è¡Œä»»åŠ¡çš„ç³»ç»Ÿã€‚å®ƒåŸºäº Kiro spec è§„èŒƒé©±åŠ¨ï¼Œå®ç°äº†ç»“æ„åŒ–çš„ä»»åŠ¡åˆ†å‘ã€ä»£ç å®¡æŸ¥å’ŒçŠ¶æ€åŒæ­¥å·¥ä½œæµã€‚

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Orchestrator (Codex/Claude)                   â”‚
â”‚  - è§£æ spec æ–‡ä»¶                                                â”‚
â”‚  - åˆ†é…ä»»åŠ¡ç»™ agents                                             â”‚
â”‚  - å†³ç­– owner_agent / target_window / criticality               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Python Orchestration Scripts                  â”‚
â”‚  init_orchestration.py â†’ dispatch_batch.py â†’ dispatch_reviews.py â”‚
â”‚                              â†“                                   â”‚
â”‚                       sync_pulse.py                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    codeagent-wrapper (Go)                        â”‚
â”‚  - å¹¶è¡Œä»»åŠ¡æ‰§è¡Œ                                                  â”‚
â”‚  - tmux ä¼šè¯ç®¡ç†                                                 â”‚
â”‚  - çŠ¶æ€æŒä¹…åŒ–                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼               â–¼               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚codex â”‚     â”‚ Gemini  â”‚     â”‚  Codex  â”‚
        â”‚ (Code)  â”‚     â”‚  (UI)   â”‚     â”‚(Review) â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. åˆå§‹åŒ–è„šæœ¬ (init_orchestration.py)

**èŒè´£**ï¼šè§£æ Kiro spec ç›®å½•ï¼Œç”Ÿæˆç¼–æ’æ‰€éœ€çš„çŠ¶æ€æ–‡ä»¶ã€‚

**è¾“å…¥**ï¼š
- `spec_path`: åŒ…å« requirements.md, design.md, tasks.md çš„ç›®å½•

**è¾“å‡º**ï¼š
- `TASKS_PARSED.json`: è§£æåçš„ä»»åŠ¡åˆ—è¡¨
- `AGENT_STATE.json`: ä»»åŠ¡çŠ¶æ€ï¼ˆscaffold æ¨¡å¼ä¸‹ä¸å« agent å†³ç­–ï¼‰
- `PROJECT_PULSE.md`: é¡¹ç›®çŠ¶æ€æ–‡æ¡£æ¨¡æ¿

**å…³é”®é€»è¾‘**ï¼š
```python
# ä¸¤ç§æ¨¡å¼
# codex æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼šç”Ÿæˆ scaffoldï¼Œç”± Codex å¡«å…… owner_agent/target_window
# legacy æ¨¡å¼ï¼šè„šæœ¬è‡ªåŠ¨åˆ†é… agentï¼ˆåŸºäºå…³é”®è¯æ£€æµ‹ï¼‰

def convert_task_to_entry(task: Task, include_decisions: bool = False):
    # include_decisions=False æ—¶ï¼Œowner_agent å’Œ criticality ä¸º None
    # Codex å¿…é¡»åœ¨ dispatch å‰å¡«å……è¿™äº›å­—æ®µ
```

**ä¸ºä»€ä¹ˆæœ‰æ•ˆ**ï¼š
- åˆ†ç¦»å…³æ³¨ç‚¹ï¼šè§£æé€»è¾‘ä¸å†³ç­–é€»è¾‘åˆ†ç¦»
- Codex å¯ä»¥åŸºäºä¸Šä¸‹æ–‡åšå‡ºæ›´æ™ºèƒ½çš„ agent åˆ†é…å†³ç­–
- æ”¯æŒçˆ¶å­ä»»åŠ¡å…³ç³»ï¼ˆsubtasks/parent_idï¼‰ç”¨äºçŠ¶æ€èšåˆ

### 2. ä»»åŠ¡è§£æå™¨ (spec_parser.py)

**èŒè´£**ï¼šè§£æ tasks.md æ–‡ä»¶ï¼Œæå–ä»»åŠ¡å®šä¹‰å’Œä¾èµ–å…³ç³»ã€‚

**æ ¸å¿ƒæ•°æ®ç»“æ„**ï¼š
```python
@dataclass
class Task:
    task_id: str           # å¦‚ "1.1", "2.3.1"
    description: str
    task_type: TaskType    # CODE, UI, REVIEW
    status: TaskStatus     # NOT_STARTED, IN_PROGRESS, etc.
    dependencies: List[str]
    is_optional: bool
    parent_id: Optional[str]
    subtasks: List[str]
    writes: List[str]      # æ–‡ä»¶å†™å…¥æ¸…å•ï¼ˆç”¨äºå†²çªæ£€æµ‹ï¼‰
    reads: List[str]       # æ–‡ä»¶è¯»å–æ¸…å•
    # Fix loop å­—æ®µ
    fix_attempts: int
    max_fix_attempts: int = 3
    review_history: List[Dict]
```

**ä¸¤éè§£æç®—æ³•**ï¼š
```python
def parse_tasks(content: str) -> TasksParseResult:
    # Pass 1: æ”¶é›†æ‰€æœ‰ä»»åŠ¡çš„åŸºæœ¬å±æ€§
    # Pass 2: æ„å»ºçˆ¶å­ä»»åŠ¡å…³ç³»ï¼ˆé¡ºåºæ— å…³ï¼‰
    _build_parent_subtask_relationships(tasks)
```

**ä¸ºä»€ä¹ˆæœ‰æ•ˆ**ï¼š
- ä¸¤éè§£æç¡®ä¿çˆ¶å­å…³ç³»æ­£ç¡®å»ºç«‹ï¼Œä¸å—æ–‡ä»¶é¡ºåºå½±å“
- æ”¯æŒä»»æ„æ·±åº¦çš„åµŒå¥—ä»»åŠ¡ï¼ˆ1.1.1.1 ç­‰ï¼‰
- æ–‡ä»¶æ¸…å•ï¼ˆwrites/readsï¼‰æ”¯æŒå†²çªæ£€æµ‹

### 3. æ‰¹é‡åˆ†å‘è„šæœ¬ (dispatch_batch.py)

**èŒè´£**ï¼šå°†å°±ç»ªä»»åŠ¡åˆ†å‘ç»™ worker agentsã€‚

**æ ¸å¿ƒæµç¨‹**ï¼š
```
1. åŠ è½½ AGENT_STATE.json
2. å¤„ç† fix_required ä»»åŠ¡ï¼ˆfix loopï¼‰
3. è·å–å°±ç»ªä»»åŠ¡ï¼ˆä¾èµ–å·²æ»¡è¶³çš„å¶å­ä»»åŠ¡ï¼‰
4. æ£€æµ‹æ–‡ä»¶å†²çªï¼Œåˆ†åŒºä¸ºæ— å†²çªæ‰¹æ¬¡
5. æ„å»ºä»»åŠ¡é…ç½®ï¼Œè°ƒç”¨ codeagent-wrapper
6. å¤„ç†æ‰§è¡ŒæŠ¥å‘Šï¼Œæ›´æ–°çŠ¶æ€
7. æ›´æ–°çˆ¶ä»»åŠ¡çŠ¶æ€
```

**ä¾èµ–æ£€æŸ¥é€»è¾‘**ï¼š
```python
def get_ready_tasks(state: Dict, strict_dependencies: bool = True):
    # 1. å¿…é¡»æ˜¯å¶å­ä»»åŠ¡ï¼ˆæ—  subtasksï¼‰
    # 2. çŠ¶æ€å¿…é¡»æ˜¯ not_started
    # 3. æ‰€æœ‰ä¾èµ–å¿…é¡»æ»¡è¶³ï¼ˆstrict æ¨¡å¼ä¸‹åªæœ‰ completed æ‰ç®—æ»¡è¶³ï¼‰
    # 4. è·³è¿‡ optional ä»»åŠ¡
    
    # å…³é”®ï¼šä¾èµ–å±•å¼€
    expanded_deps = expand_dependencies(dependencies, task_map)
    # å¦‚æœä¾èµ–æ˜¯çˆ¶ä»»åŠ¡ï¼Œå±•å¼€ä¸ºå…¶æ‰€æœ‰å­ä»»åŠ¡
```

**æ–‡ä»¶å†²çªæ£€æµ‹**ï¼š
```python
def partition_by_conflicts(tasks: List[Dict]) -> List[List[Dict]]:
    # è§„åˆ™ï¼š
    # - å†™-å†™å†²çªçš„ä»»åŠ¡æ”¾å…¥ä¸åŒæ‰¹æ¬¡
    # - æ— æ–‡ä»¶æ¸…å•çš„ä»»åŠ¡ä¸²è¡Œæ‰§è¡Œï¼ˆä¿å®ˆç­–ç•¥ï¼‰
    # - åªè¯»ä»»åŠ¡å¯ä¸éå†²çªå†™ä»»åŠ¡å¹¶è¡Œ
```

**ä¸ºä»€ä¹ˆæœ‰æ•ˆ**ï¼š
- ä¸¥æ ¼ä¾èµ–æ£€æŸ¥é˜²æ­¢ä¸‹æ¸¸ä»»åŠ¡åœ¨ä¸Šæ¸¸æœªå®Œæˆæ—¶å¯åŠ¨
- æ–‡ä»¶å†²çªåˆ†åŒºç¡®ä¿å¹¶è¡Œæ‰§è¡Œå®‰å…¨
- çˆ¶ä»»åŠ¡çŠ¶æ€è‡ªåŠ¨èšåˆï¼Œç®€åŒ–çŠ¶æ€ç®¡ç†

### 4. å®¡æŸ¥åˆ†å‘è„šæœ¬ (dispatch_reviews.py)

**èŒè´£**ï¼šä¸ºå®Œæˆçš„ä»»åŠ¡åˆ†å‘ä»£ç å®¡æŸ¥ã€‚

**å®¡æŸ¥æ•°é‡è§„åˆ™**ï¼š
```python
REVIEW_COUNT_BY_CRITICALITY = {
    "standard": 1,
    "complex": 2,
    "security-sensitive": 2,
}
```

**å®¡æŸ¥æç¤ºæ„å»º**ï¼š
```python
def build_review_content(task: Dict, spec_path: str, reviewer_index: int):
    # åŒ…å«ï¼š
    # - åŸå§‹ä»»åŠ¡æè¿°
    # - å®¡æŸ¥æŒ‡ä»¤
    # - å‚è€ƒæ–‡æ¡£è·¯å¾„
    # - å˜æ›´æ–‡ä»¶åˆ—è¡¨
    # - å®ç°æ‘˜è¦
    # - è¾“å‡ºæ ¼å¼è¦æ±‚ï¼ˆJSON with severityï¼‰
```

**ä¸ºä»€ä¹ˆæœ‰æ•ˆ**ï¼š
- åŸºäº criticality çš„å®¡æŸ¥æ•°é‡ç¡®ä¿é«˜é£é™©ä»»åŠ¡å¾—åˆ°æ›´å¤šå®¡æŸ¥
- ç»“æ„åŒ–å®¡æŸ¥è¾“å‡ºä¾¿äºè‡ªåŠ¨åŒ–å¤„ç†
- å®¡æŸ¥ç»“æœç›´æ¥å½±å“ fix loop å†³ç­–

### 5. Fix Loop æ¨¡å— (fix_loop.py)

**èŒè´£**ï¼šå¤„ç†å®¡æŸ¥å¤±è´¥åçš„ä¿®å¤å¾ªç¯ã€‚

**çŠ¶æ€æœº**ï¼š
```
pending_review â†’ under_review â†’ fix_required â†’ in_progress â†’ pending_review
                                    â†“
                              (max attempts)
                                    â†“
                                 blocked (human_fallback)
```

**æ ¸å¿ƒé€»è¾‘**ï¼š
```python
def evaluate_fix_loop_action(task: Dict, severity: str) -> FixLoopAction:
    # fix_attempts = å·²å®Œæˆçš„ä¿®å¤å°è¯•æ¬¡æ•°
    # 0 æ¬¡å®Œæˆ â†’ RETRYï¼ˆåŸ agentï¼‰
    # 1 æ¬¡å®Œæˆ â†’ RETRYï¼ˆåŸ agentï¼‰
    # 2 æ¬¡å®Œæˆ â†’ ESCALATEï¼ˆå‡çº§åˆ° Codexï¼‰
    # 3 æ¬¡å®Œæˆ â†’ HUMAN_FALLBACK
```

**ä¾èµ–é˜»å¡**ï¼š
```python
def block_dependent_tasks(state: Dict, task_id: str, reason: str):
    # å½“ä»»åŠ¡è¿›å…¥ fix_required æ—¶ï¼Œé˜»å¡æ‰€æœ‰ä¾èµ–å®ƒçš„ä»»åŠ¡
    # ä½¿ç”¨ BFS æ‰¾åˆ°ä¼ é€’é—­åŒ…
```

**ä¸ºä»€ä¹ˆæœ‰æ•ˆ**ï¼š
- æœ‰é™é‡è¯•é˜²æ­¢æ— é™å¾ªç¯
- å‡çº§æœºåˆ¶å…è®¸æ›´å¼ºå¤§çš„ agent å¤„ç†å¤æ‚é—®é¢˜
- ä¾èµ–é˜»å¡é˜²æ­¢åŸºäºé”™è¯¯ä»£ç çš„ä¸‹æ¸¸å·¥ä½œ
- äººå·¥å›é€€ç¡®ä¿æœ€ç»ˆæœ‰è§£å†³æ–¹æ¡ˆ

### 6. PULSE åŒæ­¥è„šæœ¬ (sync_pulse.py)

**èŒè´£**ï¼šå°† AGENT_STATE.json åŒæ­¥åˆ°äººç±»å¯è¯»çš„ PROJECT_PULSE.mdã€‚

**æ–‡æ¡£ç»“æ„**ï¼š
```markdown
# PROJECT_PULSE

## ğŸŸ¢ Mental Model
[ç³»ç»Ÿæ¶æ„æè¿°å’Œ Mermaid å›¾]

## ğŸŸ¡ Narrative Delta
[è¿›åº¦æ‘˜è¦ã€æœ€è¿‘å®Œæˆã€è¿›è¡Œä¸­ä»»åŠ¡]

## ğŸ”´ Risks & Debt
### Cognitive Load Warnings
### Technical Debt
### Pending Decisions

## ğŸ”— Semantic Anchors
[æ–‡ä»¶åˆ°ä»»åŠ¡çš„æ˜ å°„]
```

**24å°æ—¶å‡çº§**ï¼š
```python
def is_older_than_24h(dt_str: str) -> bool:
    # è¶…è¿‡ 24 å°æ—¶çš„ pending_decisions ä¼šè¢«æ ‡è®°ä¸º ESCALATED
```

**ä¸ºä»€ä¹ˆæœ‰æ•ˆ**ï¼š
- åŒæ–‡æ¡£ç­–ç•¥ï¼šJSON ç”¨äºæœºå™¨å¤„ç†ï¼ŒMarkdown ç”¨äºäººç±»ç†è§£
- è‡ªåŠ¨å‡çº§ç¡®ä¿å†³ç­–ä¸ä¼šè¢«é—å¿˜
- è¯­ä¹‰é”šç‚¹æä¾›ä»£ç åˆ°ä»»åŠ¡çš„å¯è¿½æº¯æ€§

### 7. codeagent-wrapper (Go)

**èŒè´£**ï¼šæ‰§è¡Œå®é™…çš„ AI åç«¯è°ƒç”¨ï¼Œç®¡ç†å¹¶è¡Œæ‰§è¡Œã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
```go
// æ‹“æ‰‘æ’åºç¡®ä¿ä¾èµ–é¡ºåº
func topologicalSort(tasks []TaskSpec) ([][]TaskSpec, error)

// å¹¶è¡Œæ‰§è¡Œå¸¦å·¥ä½œæ± é™åˆ¶
func executeConcurrentWithContext(ctx context.Context, layers [][]TaskSpec, 
    timeout int, maxWorkers int) []TaskResult

// çŠ¶æ€æŒä¹…åŒ–ï¼ˆåŸå­å†™å…¥ï¼‰
func (sw *StateWriter) WriteTaskResult(result TaskResultState) error
```

**çŠ¶æ€è½¬æ¢éªŒè¯**ï¼š
```go
var validStateTransitions = map[string]map[string]struct{}{
    "not_started":    {"in_progress": {}, "blocked": {}},
    "in_progress":    {"pending_review": {}, "blocked": {}},
    "pending_review": {"under_review": {}},
    "under_review":   {"final_review": {}},
    "final_review":   {"completed": {}, "in_progress": {}},
    "blocked":        {"in_progress": {}, "not_started": {}},
    "completed":      {},
}
```

**ä¸ºä»€ä¹ˆæœ‰æ•ˆ**ï¼š
- Go çš„å¹¶å‘åŸè¯­ï¼ˆgoroutines, channelsï¼‰é«˜æ•ˆå¤„ç†å¹¶è¡Œä»»åŠ¡
- åŸå­æ–‡ä»¶å†™å…¥é˜²æ­¢çŠ¶æ€æŸå
- çŠ¶æ€è½¬æ¢éªŒè¯ç¡®ä¿çŠ¶æ€æœºä¸€è‡´æ€§

## æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Kiro Spec                                 â”‚
â”‚  requirements.md â”€â”                                               â”‚
â”‚  design.md â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â†’ init_orchestration.py                     â”‚
â”‚  tasks.md â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TASKS_PARSED.json                              â”‚
â”‚  {                                                                â”‚
â”‚    "spec_path": "...",                                           â”‚
â”‚    "tasks": [                                                     â”‚
â”‚      {"task_id": "1.1", "description": "...", ...}               â”‚
â”‚    ]                                                              â”‚
â”‚  }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    Codex å¡«å…… owner_agent/target_window
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AGENT_STATE.json                               â”‚
â”‚  {                                                                â”‚
â”‚    "spec_path": "...",                                           â”‚
â”‚    "session_name": "orch-xxx",                                   â”‚
â”‚    "tasks": [...],                                                â”‚
â”‚    "review_findings": [...],                                      â”‚
â”‚    "final_reports": [...],                                        â”‚
â”‚    "blocked_items": [...],                                        â”‚
â”‚    "pending_decisions": [...],                                    â”‚
â”‚    "deferred_fixes": [...],                                       â”‚
â”‚    "window_mapping": {...}                                        â”‚
â”‚  }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    dispatch_batch.py / dispatch_reviews.py
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    codeagent-wrapper                              â”‚
â”‚  --parallel --tmux-session xxx --state-file AGENT_STATE.json     â”‚
â”‚                                                                   â”‚
â”‚  heredoc input:                                                   â”‚
â”‚  ---TASK---                                                       â”‚
â”‚  id: 1.1                                                          â”‚
â”‚  backend: codex                                                â”‚
â”‚  workdir: .                                                       â”‚
â”‚  ---CONTENT---                                                    â”‚
â”‚  Task: Implement feature X...                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    æ‰§è¡Œå®Œæˆï¼Œæ›´æ–°çŠ¶æ€
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    sync_pulse.py                                  â”‚
â”‚  AGENT_STATE.json â”€â”€â†’ PROJECT_PULSE.md                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä»»åŠ¡çŠ¶æ€æœº

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                         â”‚
                    â–¼                                         â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
              â”‚not_startedâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                   â”‚
                    â”‚ Worker starts                           â”‚
                    â–¼                                         â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
         â”Œâ”€â”€â”€â”€â”‚in_progressâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
         â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                       â”‚          â”‚
         â”‚          â”‚ Worker completes            â”‚          â”‚
         â”‚          â–¼                             â”‚          â”‚
         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚          â”‚
         â”‚    â”‚pending_reviewâ”‚                    â”‚          â”‚
         â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                     â”‚          â”‚
         â”‚           â”‚ Review starts              â”‚          â”‚
         â”‚           â–¼                            â”‚          â”‚
         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚          â”‚
         â”‚    â”‚under_reviewâ”‚                      â”‚          â”‚
         â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                      â”‚          â”‚
         â”‚           â”‚                            â”‚          â”‚
         â”‚     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                      â”‚          â”‚
         â”‚     â”‚           â”‚                      â”‚          â”‚
         â”‚     â–¼           â–¼                      â”‚          â”‚
         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚          â”‚
         â”‚ â”‚fix_req â”‚  â”‚final_reviewâ”‚             â”‚          â”‚
         â”‚ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚          â”‚
         â”‚     â”‚             â”‚                    â”‚          â”‚
         â”‚     â”‚ Fix         â”‚ Report             â”‚          â”‚
         â”‚     â”‚ dispatch    â”‚ produced           â”‚          â”‚
         â”‚     â”‚             â–¼                    â”‚          â”‚
         â”‚     â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚          â”‚
         â”‚     â”‚       â”‚completed â”‚               â”‚          â”‚
         â”‚     â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚          â”‚
         â”‚     â”‚                                  â”‚          â”‚
         â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
         â”‚                                                   â”‚
         â”‚ Blocker                                           â”‚
         â–¼                                                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
    â”‚ blocked â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  Blocker resolved
```

## ä¸ºä»€ä¹ˆè¿™ä¸ªç³»ç»Ÿæœ‰æ•ˆ

### 1. å…³æ³¨ç‚¹åˆ†ç¦»

- **Python è„šæœ¬**ï¼šé«˜çº§ç¼–æ’é€»è¾‘ã€çŠ¶æ€ç®¡ç†
- **Go wrapper**ï¼šä½çº§æ‰§è¡Œã€å¹¶å‘æ§åˆ¶ã€è¿›ç¨‹ç®¡ç†
- **AI Agents**ï¼šå®é™…ä»£ç ç”Ÿæˆå’Œå®¡æŸ¥

### 2. åŒæ–‡æ¡£çŠ¶æ€ç®¡ç†

- **AGENT_STATE.json**ï¼šæœºå™¨å¯è¯»ï¼Œæ”¯æŒè‡ªåŠ¨åŒ–å¤„ç†
- **PROJECT_PULSE.md**ï¼šäººç±»å¯è¯»ï¼Œæ”¯æŒæ‰‹åŠ¨å¹²é¢„

### 3. ä¸¥æ ¼çš„ä¾èµ–ç®¡ç†

- åªæœ‰ `completed` çŠ¶æ€æ‰æ»¡è¶³ä¾èµ–ï¼ˆstrict æ¨¡å¼ï¼‰
- çˆ¶ä»»åŠ¡ä¾èµ–è‡ªåŠ¨å±•å¼€ä¸ºå­ä»»åŠ¡
- é˜²æ­¢åŸºäºæœªå®¡æŸ¥ä»£ç çš„ä¸‹æ¸¸å·¥ä½œ

### 4. æ–‡ä»¶å†²çªæ£€æµ‹

- å†™-å†™å†²çªè‡ªåŠ¨åˆ†åŒº
- æ— æ¸…å•ä»»åŠ¡ä¿å®ˆä¸²è¡Œ
- ç¡®ä¿å¹¶è¡Œæ‰§è¡Œå®‰å…¨

### 5. æœ‰é™é‡è¯• + å‡çº§æœºåˆ¶

- æœ€å¤š 3 æ¬¡ä¿®å¤å°è¯•
- ç¬¬ 3 æ¬¡å‡çº§åˆ°æ›´å¼º agent
- æœ€ç»ˆäººå·¥å›é€€

### 6. åŸå­çŠ¶æ€æ›´æ–°

- Go ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ + rename ç¡®ä¿åŸå­æ€§
- Python ä½¿ç”¨ç›¸åŒæ¨¡å¼
- é˜²æ­¢çŠ¶æ€æŸå

### 7. å¯è¿½æº¯æ€§

- æ¯ä¸ªä»»åŠ¡å…³è” requirements
- å®¡æŸ¥å†å²å®Œæ•´ä¿ç•™
- è¯­ä¹‰é”šç‚¹è¿æ¥ä»£ç å’Œä»»åŠ¡

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬å·¥ä½œæµ

```bash
# 1. åˆå§‹åŒ–
python skills/multi-agent-orchestration/scripts/init_orchestration.py \
    .kiro/specs/my-feature --session my-feature --mode codex --json

# 2. Codex å¡«å…… AGENT_STATE.json ä¸­çš„ owner_agent/target_window

# 3. åˆ†å‘ä»»åŠ¡
python skills/multi-agent-orchestration/scripts/dispatch_batch.py <state_file>

# 4. åˆ†å‘å®¡æŸ¥
python skills/multi-agent-orchestration/scripts/dispatch_reviews.py <state_file>

# 5. åŒæ­¥ PULSE
python skills/multi-agent-orchestration/scripts/sync_pulse.py <state_file> <pulse_file>

# 6. æ£€æŸ¥å®ŒæˆçŠ¶æ€ï¼Œé‡å¤ 3-5 ç›´åˆ°æ‰€æœ‰ä»»åŠ¡å®Œæˆ
```

### é€šè¿‡å‘½ä»¤è°ƒç”¨

```bash
# Claude Code
/orchestrate .kiro/specs/my-feature

# Codex CLI
/prompts:orchestrate SPEC_PATH=.kiro/specs/my-feature
```

## æ‰©å±•ç‚¹

1. **æ–°å¢ Agent åç«¯**ï¼šåœ¨ `AGENT_TO_BACKEND` æ˜ å°„ä¸­æ·»åŠ 
2. **è‡ªå®šä¹‰å®¡æŸ¥è§„åˆ™**ï¼šä¿®æ”¹ `REVIEW_COUNT_BY_CRITICALITY`
3. **è°ƒæ•´é‡è¯•ç­–ç•¥**ï¼šä¿®æ”¹ `MAX_FIX_ATTEMPTS` å’Œ `ESCALATION_THRESHOLD`
4. **æ·»åŠ æ–°çŠ¶æ€**ï¼šæ›´æ–° `TaskStatus` æšä¸¾å’Œ `VALID_TRANSITIONS`

## tmux å¯è§†åŒ–æ‰§è¡Œç³»ç»Ÿï¼ˆæ·±åº¦è§£æï¼‰

tmux æ˜¯è¿™ä¸ªç³»ç»Ÿä¸­å®ç°**å¯è§†åŒ–å¹¶è¡Œæ‰§è¡Œ**çš„æ ¸å¿ƒç»„ä»¶ã€‚å®ƒä¸ä»…æä¾›äº†ä»»åŠ¡éš”ç¦»å’Œå¹¶è¡Œèƒ½åŠ›ï¼Œæ›´é‡è¦çš„æ˜¯è®©å¼€å‘è€…èƒ½å¤Ÿ**å®æ—¶è§‚å¯Ÿ**å¤šä¸ª AI agent çš„æ‰§è¡Œè¿‡ç¨‹ã€‚

### tmux æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    tmux session: orch-my-feature                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Window: main          â”‚  Window: backend      â”‚  Window: frontend   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Orchestrator    â”‚   â”‚  â”‚ Task 1.1        â”‚  â”‚  â”‚ Task 2.1        â”‚â”‚
â”‚  â”‚ (status/logs)   â”‚   â”‚  â”‚ codex        â”‚  â”‚  â”‚ gemini          â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ (split pane)    â”‚   â”‚  â”‚ Task 1.2        â”‚  â”‚  â”‚ Task 2.2        â”‚â”‚
â”‚  â”‚                 â”‚   â”‚  â”‚ codex        â”‚  â”‚  â”‚ gemini          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### tmux åœ¨æµç¨‹ä¸­çš„ä¸‰å¤§ä½œç”¨

1. **ä¼šè¯ç®¡ç† (TmuxManager)**
   - åˆ›å»º/å¤ç”¨ tmux sessionï¼ˆ`EnsureSession`ï¼‰
   - ç®¡ç†çª—å£æ•°é‡ä¸Šé™ï¼ˆ`MaxTaskWindows = 9`ï¼‰
   - ç»´æŠ¤çª—å£åç§°ç¼“å­˜ï¼Œé¿å…é‡å¤åˆ›å»º

2. **ä»»åŠ¡éš”ç¦»ä¸å¯è§†åŒ–**
   - æ¯ä¸ªä»»åŠ¡åœ¨ç‹¬ç«‹çš„ window æˆ– pane ä¸­æ‰§è¡Œ
   - ç›¸å…³ä»»åŠ¡ï¼ˆåŒä¸€ `target_window`ï¼‰å…±äº«çª—å£ï¼Œé€šè¿‡ pane åˆ†éš”
   - ä¾èµ–ä»»åŠ¡ç»§æ‰¿çˆ¶ä»»åŠ¡çš„çª—å£ï¼Œä¾¿äºè¿½è¸ªæ‰§è¡Œé“¾

3. **çŠ¶æ€æŒä¹…åŒ–ä¸è·¨æ‰¹æ¬¡ä¾èµ–**
   - `window_mapping` è®°å½• task_id â†’ window_name æ˜ å°„
   - è·¨æ‰¹æ¬¡æ‰§è¡Œæ—¶ï¼Œæ–°ä»»åŠ¡å¯ä»¥æ‰¾åˆ°ä¾èµ–ä»»åŠ¡çš„çª—å£
   - æ”¯æŒæ–­ç‚¹ç»­è·‘å’ŒçŠ¶æ€æ¢å¤

### æ ¸å¿ƒä»£ç ç»„ä»¶

#### 1. TmuxManager (`codeagent-wrapper/internal/wrapper/tmux.go`)

```go
type TmuxManager struct {
    config TmuxConfig
    mu     sync.Mutex
    windowNames     map[string]bool  // å·²åˆ›å»ºçš„çª—å£
    windowCount     int              // å½“å‰çª—å£æ•°ï¼ˆä¸å« mainï¼‰
    windowCacheInit bool             // ç¼“å­˜æ˜¯å¦å·²åˆå§‹åŒ–
}

// å…³é”®æ–¹æ³•
func (tm *TmuxManager) EnsureSession() error      // ç¡®ä¿ session å­˜åœ¨
func (tm *TmuxManager) CreateWindow(taskID) error // ä¸ºä»»åŠ¡åˆ›å»ºæ–°çª—å£
func (tm *TmuxManager) CreatePane(window) error   // åœ¨çª—å£ä¸­åˆ›å»ºæ–° pane
func (tm *TmuxManager) GetOrCreateWindow(name)    // è·å–æˆ–åˆ›å»ºæŒ‡å®šçª—å£
func (tm *TmuxManager) SendCommand(target, cmd)   // å‘ç›®æ ‡å‘é€å‘½ä»¤
```

#### 2. tmuxTaskRunner (`codeagent-wrapper/internal/wrapper/tmux_execution.go`)

```go
type tmuxTaskRunner struct {
    manager      *TmuxManager
    stateWriter  *StateWriter
    isReview     bool
    windowFor    string           // å¼ºåˆ¶æ‰€æœ‰ä»»åŠ¡ä½¿ç”¨æŒ‡å®šçª—å£
    windowByTask map[string]string // å½“å‰æ‰¹æ¬¡çš„ taskâ†’window æ˜ å°„
}

// æ ¸å¿ƒæ‰§è¡Œæµç¨‹
func (r *tmuxTaskRunner) run(task TaskSpec, timeout int) TaskResult {
    // 1. å‡†å¤‡æ‰§è¡Œç›®æ ‡ï¼ˆwindow/paneï¼‰
    target, err := r.prepareTarget(task)
    
    // 2. æ„å»ºæ‰§è¡Œå‘½ä»¤
    command := buildTmuxCommand(task, backend, args, outPath, errPath, exitPath, inputPath, doneSignal)
    
    // 3. å‘é€å‘½ä»¤åˆ° tmux
    r.manager.SendCommand(target.target, command)
    
    // 4. ç­‰å¾…å®Œæˆä¿¡å·ï¼ˆtmux wait-forï¼‰
    tmuxWaitForFn(ctx, doneSignal)
    
    // 5. è¯»å–ç»“æœå¹¶æ›´æ–°çŠ¶æ€
    return result
}
```

#### 3. çª—å£åˆ†é…ç­–ç•¥ (`prepareTarget`)

```go
func (r *tmuxTaskRunner) prepareTarget(task TaskSpec) (tmuxTarget, error) {
    // ä¼˜å…ˆçº§ 1: å¼ºåˆ¶çª—å£æ¨¡å¼ï¼ˆ--window-for å‚æ•°ï¼‰
    if r.windowFor != "" {
        return r.manager.CreatePane(r.windowFor)
    }
    
    // ä¼˜å…ˆçº§ 2: ä»»åŠ¡æŒ‡å®šçš„ target_window
    if task.TargetWindow != "" {
        windowName, created := r.manager.GetOrCreateWindow(task.TargetWindow)
        if created {
            return target  // æ–°çª—å£ï¼Œç›´æ¥ä½¿ç”¨
        }
        return r.manager.CreatePane(windowName)  // å·²å­˜åœ¨ï¼Œåˆ›å»º pane
    }
    
    // ä¼˜å…ˆçº§ 3: æ— ä¾èµ–ä»»åŠ¡ â†’ åˆ›å»ºç‹¬ç«‹çª—å£
    if len(task.Dependencies) == 0 {
        return r.manager.CreateWindow(taskID)
    }
    
    // ä¼˜å…ˆçº§ 4: æœ‰ä¾èµ– â†’ ç»§æ‰¿ä¾èµ–ä»»åŠ¡çš„çª—å£
    depID := task.Dependencies[0]
    windowName := r.windowByTask[depID]  // å…ˆæŸ¥å½“å‰æ‰¹æ¬¡
    if windowName == "" {
        // è·¨æ‰¹æ¬¡ï¼šä»æŒä¹…åŒ–çŠ¶æ€è¯»å–
        persistedMapping := r.stateWriter.GetWindowMapping()
        windowName = persistedMapping[depID]
    }
    return r.manager.CreatePane(windowName)
}
```

### å‘½ä»¤æ‰§è¡Œæœºåˆ¶

æ¯ä¸ªä»»åŠ¡åœ¨ tmux ä¸­çš„æ‰§è¡Œé€šè¿‡ `buildTmuxCommand` æ„å»ºï¼š

```bash
bash -lc 'set -o pipefail; cd /workdir; \
  cat /tmp/input | codex args 2> /tmp/err | tee /tmp/out; \
  echo $? > /tmp/exit; \
  tmux wait-for -S codeagent-done-task-001-1234567890'
```

å…³é”®ç‚¹ï¼š
- `set -o pipefail`ï¼šç¡®ä¿ç®¡é“ä¸­ä»»ä½•å‘½ä»¤å¤±è´¥éƒ½èƒ½è¢«æ•è·
- `tee`ï¼šåŒæ—¶è¾“å‡ºåˆ°ç»ˆç«¯å’Œæ–‡ä»¶ï¼Œä¾¿äºå®æ—¶è§‚å¯Ÿå’Œåç»­åˆ†æ
- `tmux wait-for -S`ï¼šå‘é€å®Œæˆä¿¡å·ï¼Œé€šçŸ¥ wrapper ä»»åŠ¡ç»“æŸ

### ä¸ dispatch_batch.py çš„é›†æˆ

```python
def invoke_codeagent_wrapper(configs, session_name, state_file, dry_run=False):
    heredoc_input = build_heredoc_input(configs)
    
    cmd = [
        "codeagent-wrapper",
        "--parallel",
        "--tmux-session", session_name,  # æŒ‡å®š tmux session
        "--state-file", state_file,       # çŠ¶æ€æ–‡ä»¶è·¯å¾„
    ]
    
    result = subprocess.run(cmd, input=heredoc_input, ...)
```

heredoc è¾“å…¥æ ¼å¼ï¼š
```
---TASK---
id: 1.1
backend: codex
workdir: .
dependencies: 
target_window: backend
---CONTENT---
Task: Implement user authentication...
```

### çŠ¶æ€åŒæ­¥ä¸è·¨æ‰¹æ¬¡ä¾èµ–

`AGENT_STATE.json` ä¸­çš„ `window_mapping` å­—æ®µï¼š

```json
{
  "window_mapping": {
    "1.1": "backend",
    "1.2": "backend",
    "2.1": "frontend",
    "2.2": "frontend"
  }
}
```

è·¨æ‰¹æ¬¡ä¾èµ–å¤„ç†æµç¨‹ï¼š
1. æ‰¹æ¬¡ 1 æ‰§è¡Œä»»åŠ¡ 1.1ï¼Œåˆ›å»ºçª—å£ `backend`ï¼Œè®°å½•åˆ° `window_mapping`
2. æ‰¹æ¬¡ 2 æ‰§è¡Œä»»åŠ¡ 1.3ï¼ˆä¾èµ– 1.1ï¼‰ï¼Œä» `window_mapping` è¯»å– `backend`
3. ä»»åŠ¡ 1.3 åœ¨ `backend` çª—å£ä¸­åˆ›å»ºæ–° pane æ‰§è¡Œ

### tmux å¯è§†åŒ–è°ƒè¯•æŒ‡å—

#### è¿æ¥åˆ°æ‰§è¡Œ session
```bash
tmux attach -t orch-my-feature
```

#### çª—å£å¯¼èˆª
- `Ctrl+b n` - ä¸‹ä¸€ä¸ªçª—å£
- `Ctrl+b p` - ä¸Šä¸€ä¸ªçª—å£
- `Ctrl+b w` - çª—å£åˆ—è¡¨
- `Ctrl+b 0-9` - è·³è½¬åˆ°æŒ‡å®šçª—å£

#### Pane å¯¼èˆª
- `Ctrl+b o` - åˆ‡æ¢ pane
- `Ctrl+b z` - æœ€å¤§åŒ–/è¿˜åŸå½“å‰ pane

#### æŸ¥çœ‹å†å²è¾“å‡º
- `Ctrl+b [` - è¿›å…¥å¤åˆ¶æ¨¡å¼ï¼Œå¯æ»šåŠ¨æŸ¥çœ‹å†å²
- `q` - é€€å‡ºå¤åˆ¶æ¨¡å¼

### å¤±è´¥æ’æŸ¥æµç¨‹

1. **å®šä½å¤±è´¥ä»»åŠ¡**
   ```bash
   jq '.tasks[] | select(.status == "blocked") | {task_id, window_id, pane_id, error}' AGENT_STATE.json
   ```

2. **è¿æ¥åˆ°å¯¹åº”çª—å£**
   ```bash
   tmux select-window -t orch-my-feature:backend
   ```

3. **æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—**
   - ä»»åŠ¡è¾“å‡ºï¼š`/tmp/codeagent-tmux-out-*`
   - é”™è¯¯è¾“å‡ºï¼š`/tmp/codeagent-tmux-err-*`
   - é€€å‡ºç ï¼š`/tmp/codeagent-tmux-exit-*`

### tmux æœ€ä½³å®è·µ

| å®è·µ | è¯´æ˜ |
|------|------|
| Session å‘½å | ä¸ spec æˆ–åŠŸèƒ½ä¸€è‡´ï¼ˆå¦‚ `orch-user-auth`ï¼‰ |
| Window åˆ†ç»„ | æŒ‰åŠŸèƒ½æ¨¡å—åˆ’åˆ†ï¼ˆ`setup`/`backend`/`frontend`/`tests`ï¼‰ |
| å¹¶è¡Œåº¦æ§åˆ¶ | é€šè¿‡ `CODEAGENT_MAX_WORKERS` ç¯å¢ƒå˜é‡é™åˆ¶ |
| çª—å£æ•°é‡ | é»˜è®¤æœ€å¤š 9 ä¸ªä»»åŠ¡çª—å£ï¼Œè¶…å‡ºä¼šæŠ¥é”™ |
| çŠ¶æ€æ¢å¤ | ä¸­æ–­åå¯é€šè¿‡ `--state-file` æ¢å¤æ‰§è¡Œä¸Šä¸‹æ–‡ |

### ä¸ºä»€ä¹ˆ tmux æ˜¯å…³é”®

1. **å¯è§‚æµ‹æ€§**ï¼šå®æ—¶æŸ¥çœ‹æ¯ä¸ª agent çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œè€Œéé»‘ç›’ç­‰å¾…
2. **éš”ç¦»æ€§**ï¼šä»»åŠ¡é—´äº’ä¸å¹²æ‰°ï¼Œä¸€ä¸ªä»»åŠ¡å¤±è´¥ä¸å½±å“å…¶ä»–ä»»åŠ¡çš„è¾“å‡º
3. **æŒä¹…æ€§**ï¼šæ–­å¼€è¿æ¥åä»»åŠ¡ç»§ç»­æ‰§è¡Œï¼Œé‡è¿åå¯æŸ¥çœ‹å†å²
4. **è°ƒè¯•å‹å¥½**ï¼šå¤±è´¥æ—¶å¯ç›´æ¥è¿›å…¥å¯¹åº” pane æŸ¥çœ‹ä¸Šä¸‹æ–‡
5. **è·¨æ‰¹æ¬¡è¿½è¸ª**ï¼šé€šè¿‡ `window_mapping` ä¿æŒä»»åŠ¡æ‰§è¡Œçš„è¿ç»­æ€§

## æ€»ç»“

Multi-Agent Orchestration ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹è®¾è®¡å®ç°äº†å¯é çš„å¤šä»£ç†åä½œï¼š

1. **å£°æ˜å¼è§„èŒƒ**ï¼šåŸºäº Kiro spec é©±åŠ¨
2. **åˆ†å±‚æ¶æ„**ï¼šPython ç¼–æ’ + Go æ‰§è¡Œ
3. **çŠ¶æ€æœºé©±åŠ¨**ï¼šä¸¥æ ¼çš„çŠ¶æ€è½¬æ¢
4. **å®‰å…¨å¹¶è¡Œ**ï¼šå†²çªæ£€æµ‹ + ä¾èµ–ç®¡ç†
5. **è‡ªæ„ˆæœºåˆ¶**ï¼šfix loop + å‡çº§ + äººå·¥å›é€€
6. **å¯è§‚æµ‹æ€§**ï¼šåŒæ–‡æ¡£ + å®Œæ•´å†å²
7. **tmux å¯è§†åŒ–**ï¼šå®æ—¶è§‚å¯Ÿ + ä»»åŠ¡éš”ç¦» + è·¨æ‰¹æ¬¡è¿½è¸ª

è¿™ç§è®¾è®¡ä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿå¤„ç†å¤æ‚çš„å¤šä»»åŠ¡ç¼–æ’ï¼ŒåŒæ—¶ä¿æŒå¯é æ€§å’Œå¯è¿½æº¯æ€§ã€‚
